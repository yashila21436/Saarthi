<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Projects - Brand</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800&amp;display=swap">
    <link rel="stylesheet" href="assets/css/bs-theme-overrides.css">



    <script>
        // Function to extract user details from URL query parameters
        function getUserDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('Id');
            const userName = urlParams.get('Name');
            const userEmail = urlParams.get('Email');
            const userRollNo = urlParams.get('RollNo');
            return { Id: userId, Name: userName, Email: userEmail, RollNo: userRollNo };
        }

        // Function to dynamically generate link to About section with user details
        function generateAboutLink() {
            const userDetails = getUserDetails();
            const aboutLink = `about_Student.html?Id=${encodeURIComponent(userDetails.Id)}&Name=${encodeURIComponent(userDetails.Name)}&Email=${encodeURIComponent(userDetails.Email)}&RollNo=${encodeURIComponent(userDetails.RollNo)}`;
            return aboutLink;
        }

        function generateProjectLink(){
            const userDetails = getUserDetails();
            const userLink = `projects_students.html?Id=${encodeURIComponent(userDetails.Id)}&Name=${encodeURIComponent(userDetails.Name)}&Email=${encodeURIComponent(userDetails.Email)}&RollNo=${encodeURIComponent(userDetails.RollNo)}`;
            return userLink;

        }

        function generateFaq(){
            const userDetails = getUserDetails();
            const userLink = `faq_student.html?Id=${encodeURIComponent(userDetails.Id)}&Name=${encodeURIComponent(userDetails.Name)}&Email=${encodeURIComponent(userDetails.Email)}&RollNo=${encodeURIComponent(userDetails.RollNo)}`;
            return userLink;

        }

        function generateindex(){
            const userDetails = getUserDetails();
            const userLink = `index.html?Id=${encodeURIComponent(userDetails.Id)}&Name=${encodeURIComponent(userDetails.Name)}&Email=${encodeURIComponent(userDetails.Email)}&RollNo=${encodeURIComponent(userDetails.RollNo)}`;
            return userLink;


        }
    </script>
    <script>
        // Parses URL query parameters
        function getQueryParams() {
            var queryParams = {};
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (typeof queryParams[decodeURIComponent(pair[0])] === "undefined") {
                    queryParams[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                } else if (typeof queryParams[decodeURIComponent(pair[0])] === "string") {
                    var arr = [queryParams[decodeURIComponent(pair[0])], decodeURIComponent(pair[1])];
                    queryParams[decodeURIComponent(pair[0])] = arr;
                } else {
                    queryParams[decodeURIComponent(pair[0])].push(decodeURIComponent(pair[1]));
                }
            }
            return queryParams;
        }

        // Redirects to the dashboard with parameters from the URL
        function redirectToDashboard() {
            const params = getQueryParams();
            const baseUrl = "http://localhost:63342/isyfinal/public/studentDashboard.html";
            const queryParams = `?Id=${encodeURIComponent(params.Id)}&Name=${encodeURIComponent(params.Name)}&Email=${encodeURIComponent(params.Email)}&RollNo=${encodeURIComponent(params.RollNo)}`;
            const fullUrl = baseUrl + queryParams;
            window.location.href = fullUrl;
        }
    </script>
</head>
<style>
    .card-button {
        width: 100%; /* Makes the button expand to the full width of the card */
        margin-bottom: 0.5rem; /* Adds a little space below the button */
    }
    /* You can also add more styles to make it look even better */
</style>
<body style="background: #19181d;">
<nav class="navbar navbar-expand-md sticky-top py-3 navbar-dark" id="mainNav" style="padding-right: 0px;margin-right: 1px;">
    <div class="container"><a class="navbar-brand d-flex align-items-center" href="index.html"><span class="bs-icon-sm bs-icon-circle bs-icon-primary shadow d-flex justify-content-center align-items-center me-2 bs-icon" style="background: var(--bs-body-bg);"><img src="assets/img/SAARTHI%20LOGO%201.png" width="33" height="33"></span><span>Saarthi</span></a><button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-1"><span class="visually-hidden">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navcol-1">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item"><a class="nav-link" href="javascript:void(0)" onclick="location.href = generateindex()">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="javascript:void(0)" onclick="location.href = generateAboutLink()">About</a></li>


                <li class="nav-item"><a class="nav-link active" href="projects.html">Projects</a></li>
                <li class="nav-item"></li>
                <li class="nav-item"><a class="nav-link" href="javascript:void(0)" onclick="location.href = generateFaq()">FAQs</a></li>
                <li class="nav-item"></li>
                <li class="nav-item"></li>
                <li class="nav-item"></li>

            </ul><a onclick="redirectToDashboard()" style="cursor: pointer; font-size: 34px; color: var(--bs-primary);">
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" style="font-size: 34px;color: var(--bs-primary);">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M16 9C16 11.2091 14.2091 13 12 13C9.79086 13 8 11.2091 8 9C8 6.79086 9.79086 5 12 5C14.2091 5 16 6.79086 16 9ZM14 9C14 10.1046 13.1046 11 12 11C10.8954 11 10 10.1046 10 9C10 7.89543 10.8954 7 12 7C13.1046 7 14 7.89543 14 9Z" fill="currentColor"></path>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1ZM3 12C3 14.0902 3.71255 16.014 4.90798 17.5417C6.55245 15.3889 9.14627 14 12.0645 14C14.9448 14 17.5092 15.3531 19.1565 17.4583C20.313 15.9443 21 14.0524 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12ZM12 21C9.84977 21 7.87565 20.2459 6.32767 18.9878C7.59352 17.1812 9.69106 16 12.0645 16C14.4084 16 16.4833 17.1521 17.7538 18.9209C16.1939 20.2191 14.1881 21 12 21Z" fill="currentColor"></path>
            </svg>
        </a>
        </div>
    </div>
</nav>
<section class="py-5">
    <div class="container">
        <h2 class="fw-bold text-center text-white mb-4" style="font-size: 40px;"><strong>Available Projects</strong></h2>
        <div id="projectList" class="row g-4"></div>
    </div>
</section>

<footer class="bg-dark">
    <div class="container py-4 py-lg-5">
        <hr>
        <div class="text-muted d-flex justify-content-between align-items-center pt-3">
            <p class="mb-0">Copyright Â© 2024 by Aditi, Kanishk, Rahul &amp; Yashila</p>
            <ul class="list-inline mb-0"></ul>
        </div>
    </div>
</footer>

<div class="modal fade" id="viewApplicationsModal" tabindex="-1" aria-labelledby="viewApplicationsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewApplicationsLabel">Project Applications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="applicationsList">
                <!-- Applications details will be dynamically added here -->
            </div>
        </div>
    </div>
</div>

<!-- Add this to your HTML file -->
<div id="updatingOverlay" class="updating-overlay">
    <div class="updating-message">Application status update is in process...</div>
</div>


<!-- Update Modal -->
<div class="modal" tabindex="-1" role="dialog" id="updateModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Application Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Application status update is in process...</p>
            </div>
        </div>
    </div>
</div>
<!-- Application Modal -->
<div class="modal fade" id="applyModal" tabindex="-1" aria-labelledby="applyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applyModalLabel">Apply for Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="applicationForm">
                    <div class="mb-3">
                        <label for="skills" class="form-label">Relevant Skills</label>
                        <textarea class="form-control" id="skills" name="skills" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Application</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal to show applied students -->
<div class="modal fade" id="appliedStudentsModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Applied Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="appliedStudentsList">
                <!-- Applied students will be dynamically added here -->
            </div>
        </div>
    </div>
</div>
<script src="assets/bootstrap/js/bootstrap.min.js"></script>
<script src="assets/js/bold-and-dark.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    let currentProjectId = null;
    const studentId = getParameterByName('Id');
    const studentName = getParameterByName('Name');
    const studentEmail = getParameterByName('Email');

    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function setCurrentProjectId(jobId) {
        currentProjectId = jobId;
    }

    document.getElementById('applicationForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const skills = document.getElementById('skills').value;
        submitApplication(currentProjectId, skills);
    });

    function submitApplication(jobId, skills) {
        fetch('http://localhost:3000/submit-application', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                studentId: studentId,
                studentName: studentName,
                email: studentEmail,
                projectId: jobId,
                skills: skills,
                status: 'Applied',
                final: 0
            })
        })
            .then(response => response.json())
            .then(data => {
                alert('Application submitted successfully!');
                $('#applyModal').modal('hide');
                document.querySelector(`button[data-project-id="${jobId}"]`).textContent = 'Application Sent';
                document.querySelector(`button[data-project-id="${jobId}"]`).disabled = true;
            })
            .catch(error => {
                console.error('Error submitting application:', error);
                alert('Failed to submit application.');
            });
    }

    // window.onload = function () {
    //     fetch(`http://localhost:3000/project_students`)
    //         .then(response => response.json())
    //         .then(projectsData => {
    //             const projectList = document.getElementById("projectList");
    //             projectList.innerHTML = ''; // Clear existing entries
    //             projectsData.forEach(project => {
    //                 const hasApplied = checkIfApplied(project.job_id); // This needs to be implemented
    //                 const card = document.createElement("div");
    //                 card.className = "col-md-4";
    //                 card.innerHTML = `
    //             <div class="card h-100 bg-dark text-white">
    //                 <div class="card-body">
    //                     <h5 class="card-title"><strong>${project.project_name}</strong></h5>
    //                     <p class="card-text">${project.about_ngo}</p>
    //                     <p class="card-text"><strong>Duration:</strong> ${project.duration}</p>
    //                     <p class="card-text"><strong>Skills Required:</strong> ${project.required_skills}</p>
    //                     <p class="card-text"><strong>Contact:</strong> ${project.contact}</p>
    //                     <button class="btn btn-success card-button" data-bs-toggle="modal" data-bs-target="#applyModal" data-project-id="${project.job_id}" onclick="setCurrentProjectId(${project.job_id})">${hasApplied ? 'Application Sent' : 'Apply'}</button>
    //                 </div>
    //             </div>
    //             `;
    //                 projectList.appendChild(card);
    //             });
    //         })
    //         .catch(error => {
    //             console.error('Failed to fetch projects:', error);
    //             projectList.innerHTML = '<p class="text-white text-center">Error loading projects.</p>';
    //         });
    // };
    window.onload = function () {
        fetch(`http://localhost:3000/project_students`)
            .then(response => response.json())
            .then(projectsData => {
                // Prepare promises to check each project application status
                let checks = projectsData.map(project => {
                    return fetch(`http://localhost:3000/check-application?studentId=${studentId}&projectId=${project.job_id}`)
                        .then(response => response.json())
                        .then(data => {
                            // Add 'applied' flag directly to project data for easier access
                            project.applied = data.applied;
                            return project;
                        })
                        .catch(error => {
                            console.error('Failed to check application status:', error);
                            project.applied = false; // Assume not applied if error occurs
                            return project;
                        });
                });

                // Resolve all check promises and then sort and render the projects
                Promise.all(checks).then(projects => {
                    // Sort projects by 'applied' status (false first, then true)
                    projects.sort((a, b) => {
                        return (a.applied === b.applied) ? 0 : a.applied ? 1 : -1;
                    });

                    // Now render the sorted projects
                    const projectList = document.getElementById("projectList");
                    projectList.innerHTML = ''; // Clear existing entries
                    projects.forEach(project => {
                        const card = document.createElement("div");
                        card.className = "col-md-4";
                        const applyButton = document.createElement("button");
                        applyButton.className = "btn btn-success card-button";
                        applyButton.setAttribute("data-project-id", project.job_id);
                        if (project.applied) {
                            applyButton.textContent = 'Application Sent';
                            applyButton.disabled = true;
                        } else {
                            applyButton.textContent = 'Apply';
                            applyButton.onclick = function() {
                                setCurrentProjectId(project.job_id);
                            };
                            applyButton.setAttribute("data-bs-toggle", "modal");
                            applyButton.setAttribute("data-bs-target", "#applyModal");
                        }

                        card.innerHTML = `
                        <div class="card h-100 bg-dark text-white">
                            <div class="card-body">
                                <h5 class="card-title"><strong>${project.project_name}</strong></h5>
                                <p class="card-text">${project.about_ngo}</p>
                                <p class="card-text"><strong>NGO:</strong> ${project.orgName}</p>
                                <p class="card-text"><strong>Duration:</strong> ${project.duration}</p>
                                <p class="card-text"><strong>Skills Required:</strong> ${project.required_skills}</p>
                                <p class="card-text"><strong>Contact:</strong> ${project.contact}</p>
                            </div>
                        </div>
                    `;
                        card.querySelector('.card-body').appendChild(applyButton);
                        projectList.appendChild(card);
                    });
                });
            })
            .catch(error => {
                console.error('Failed to fetch projects:', error);
                const projectList = document.getElementById("projectList");
                projectList.innerHTML = '<p class="text-white text-center">Error loading projects.</p>';
            });
    };




    function checkIfApplied(jobId) {
        // Implement fetching application status for a particular job ID and student ID
        return false; // Placeholder
    }

</script>

</body>
</html>